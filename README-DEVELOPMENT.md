# Development Guide

## Prerequisites

| Tool | Version | Notes |
|------|---------|-------|
| **JDK** | 21+ | LTS. The build auto-provisions via [foojay toolchain resolver](https://github.com/gradle/foojay-toolchains). |
| **Gradle** | 8.14.4 | Bundled via wrapper (`./gradlew`). |
| **Kotlin** | 2.3.10 | Configured in `build.gradle` plugin block. |
| **GraalVM CE** | 21+ | Only needed for native-image builds. Set `GRAALVM_HOME`. |

## Project Structure

```
build.gradle                  # Main build — JARs, R8, shadow, native-image tasks
settings.gradle               # Repos, foojay toolchain resolver, subproject includes
libs/kotlin-html-master/      # Vendored HTML generation library (subproject)
src/main/kotlin/              # Application source
src/main/shrink-rules.pro     # R8/ProGuard keep rules for the lite JAR
src/main/graalvm/             # GraalVM native-image configs (auto-generated by tracing agent)
samples/configs/              # Sample JSON configs for testing
```

## Build Artifacts

The build produces three JAR variants plus an optional native binary:

| Artifact | Gradle Task | Description | Size |
|----------|-------------|-------------|------|
| `apkSize-<ver>-full.jar` | `shadowJar` | Fat JAR with bundletool embedded. Runs AAB analysis standalone. | ~48 MB |
| `apkSize-<ver>-lite.jar` | `shadowJarLite` | Fat JAR without bundletool (pre-R8). | ~32 MB |
| `apkSize-<ver>-lite-r8.jar` | `r8Jar` | R8-minified lite JAR. For AAB, pass `--bundletoolJarPath`. | ~5 MB |
| `apksize` (native) | `nativeImageLite` | GraalVM native binary from the lite-r8 JAR. Instant startup, no JRE. | ~21 MB |

## Building

### All JARs (full + lite + lite-r8)

```bash
./gradlew clean assemble
ls -lh build/libs/
```

### Individual Tasks

```bash
./gradlew shadowJar         # Full JAR only
./gradlew shadowJarLite     # Lite JAR only (pre-R8)
./gradlew r8Jar             # Lite JAR → R8 minified
```

## GraalVM Native Image

### One-Time Setup

Install GraalVM CE 21+ and set the environment variable:

```bash
# macOS (SDKMAN)
sdk install java 21.0.2-graalce
export GRAALVM_HOME=$HOME/.sdkman/candidates/java/21.0.2-graalce

# macOS (manual)
export GRAALVM_HOME=/Library/Java/JavaVirtualMachines/graalvm-ce-21/Contents/Home

# Linux
export GRAALVM_HOME=/usr/lib/jvm/graalvm-ce-21

# Verify
$GRAALVM_HOME/bin/native-image --version
```

### Build Native Binary

```bash
export GRAALVM_HOME=/path/to/graalvm
./gradlew nativeImageLite
# Output: build/native/apksize
```

Build time is ~3-4 minutes. The binary is self-contained (no JRE needed).

### Regenerate GraalVM Configs

If you add new model classes, change Gson serialization, or add reflective code, regenerate
the tracing agent configs in `src/main/graalvm/`:

```bash
export GRAALVM_HOME=/path/to/graalvm

# Run with the tracing agent (exercises AAB + bundletool code paths)
./gradlew nativeImageAgentConfig \
  -PnativeTestArgs='abs --config=samples/configs/config-aab.json --bundletoolJarPath=/path/to/bundletool-all.jar'
```

This runs the lite-r8 JAR with the GraalVM tracing agent and overwrites the config files in
`src/main/graalvm/`. Commit the updated configs.

To cover additional code paths (e.g., APK analysis, diff mode), run the agent multiple times
with `config-merge-dir` instead:

```bash
$GRAALVM_HOME/bin/java \
  -agentlib:native-image-agent=config-merge-dir=src/main/graalvm \
  -jar build/libs/apkSize-*-lite-r8.jar \
  abs --config=samples/configs/config-all.json
```

## Testing

### Run with the Full JAR (AAB)

```bash
java -jar build/libs/apkSize-*-full.jar abs --config=samples/configs/config-aab.json
```

### Run with the Lite R8 JAR (AAB + external bundletool)

```bash
java -jar build/libs/apkSize-*-lite-r8.jar abs \
  --config=samples/configs/config-aab.json \
  --bundletoolJarPath=/path/to/bundletool-all.jar
```

### Run with the Native Binary

```bash
./build/native/apksize abs \
  --config=samples/configs/config-aab.json \
  --bundletoolJarPath=/path/to/bundletool-all.jar
```

> **Note:** JDK 21+ is required to _run_ the JARs. The native binary has no JDK requirement.

## Gradle Tasks Reference

| Task | Group | Description |
|------|-------|-------------|
| `assemble` | build | Builds full JAR + lite-r8 JAR |
| `shadowJar` | shadow | Full fat JAR (with bundletool) |
| `shadowJarLite` | shadow | Lite fat JAR (no bundletool) |
| `r8Jar` | — | R8-minify the lite JAR |
| `nativeImageLite` | native | Build GraalVM native binary from lite-r8 JAR |
| `nativeImageAgentConfig` | native | Run tracing agent to regenerate `src/main/graalvm/` configs |

## Toolchain Details

- **JVM 21** is set via `kotlin { jvmToolchain(21) }` — Gradle auto-provisions the JDK.
- **`nativeImageCapable = true`** in `java.toolchain` tells Gradle to prefer GraalVM JDKs.
- **foojay resolver** (`settings.gradle`) enables automatic JDK downloads from Adoptium/GraalVM.
- **R8 8.8.25** handles Java 21 bytecode; hosted on the R8 GCS releases repository.

## CI/CD

GitHub Actions workflows are in `.github/workflows/`:

- **`release.yml`** — Triggered on release creation or manual dispatch. Builds all JAR variants
  and native binaries (Linux x64, macOS ARM, macOS x64), then uploads them to the GitHub release.
