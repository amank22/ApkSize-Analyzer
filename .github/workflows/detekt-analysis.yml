# Static analysis and configuration checks for the ApkSize-Analyzer project.
#
# Jobs:
#   1. detekt  — Kotlin static analysis via Detekt CLI
#   2. graalvm — Verifies reflect-config.json covers all Gson-serialized model classes
#
# Triggers:
#   - Push / PR to main
#   - Weekly schedule
#   - Manual dispatch
name: Static Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '40 8 * * 1'
  workflow_dispatch:

env:
  DETEKT_RELEASE_TAG: v1.23.8
  DETEKT_VERSION: 1.23.8

jobs:

  # ── GraalVM reflect-config verification ──────────────────────────────────
  graalvm-reflect-check:
    name: Verify reflect-config.json
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Verify reflect-config covers all model classes
        run: ./gradlew verifyReflectConfig --no-daemon

  # ── Detekt static analysis ──────────────────────────────────────────────
  detekt:
    name: Detekt Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Detekt
        run: |
          dest=$( mktemp -d )
          curl --request GET \
            --url "https://github.com/detekt/detekt/releases/download/${DETEKT_RELEASE_TAG}/detekt-cli-${DETEKT_VERSION}-all.jar" \
            --silent \
            --location \
            --fail \
            --output $dest/detekt-cli.jar
          echo "DETEKT_JAR=$dest/detekt-cli.jar" >> "$GITHUB_ENV"

      - name: Run Detekt
        continue-on-error: true
        run: |
          java -jar "$DETEKT_JAR" --input ${{ github.workspace }} --report sarif:${{ github.workspace }}/detekt.sarif.json

      - name: Make artifact location URIs relative
        continue-on-error: true
        run: |
          echo "$(
            jq \
              --arg github_workspace ${{ github.workspace }} \
              '. | ( .runs[].results[].locations[].physicalLocation.artifactLocation.uri |= if test($github_workspace) then .[($github_workspace | length | . + 1):] else . end )' \
              ${{ github.workspace }}/detekt.sarif.json
          )" > ${{ github.workspace }}/detekt.sarif.json

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ github.workspace }}/detekt.sarif.json
          checkout_path: ${{ github.workspace }}
